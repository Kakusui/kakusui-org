<!-- 
Copyright Kakusui LLC 2024 (https://kakusui.org) (https://github.com/Kakusui)
Use of this source code is governed by a GNU General Public License v3.0
license that can be found in the LICENSE file.
-->

{% extends "base.html" %}

{% block title %}
Kakusui | Kairyou
{% endblock %}

{% block content %}
<div class="container">
    <h1>Kairyou</h1>
    <div class="row">
        <div class="col">
            <h2>Text Input</h2>
            <textarea class="form-control" id="textToPreprocess" rows="3"></textarea>
            <input type="file" class="form-control" id="textFileInput">
        </div>
        <div class="col">
            <h2>JSON Input</h2>
            <textarea class="form-control" id="replacementsJson" rows="3"></textarea>
            <input type="file" class="form-control" id="jsonFileInput">
        </div>
    </div>
    <div class="row">
        <div class="col">
            <button class="btn btn-primary" id="submitButton">Submit</button>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <h2>Preprocessed Text</h2>
            <textarea class="form-control" id="preprocessedText" rows="3" readonly></textarea>
        </div>
        <div class="col">
            <h2>Preprocessing Log</h2>
            <textarea class="form-control" id="preprocessingLog" rows="3" readonly></textarea>
        </div>
        <div class="col">
            <h2>Error Log</h2>
            <textarea class="form-control" id="errorLog" rows="3" readonly></textarea>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    const apiKey = "{{ api_key }}";
    const isLocal = " {{ is_local }}" ? 'true' : 'false';
    const apiUrl = isLocal === 'true' ? "http://api.localhost:5000/v1/kairyou" : "https://api.kakusui.org/v1/kairyou";

    function makeApiRequest() {
        const textToPreprocess = document.getElementById('textToPreprocess').value;
        let replacementsJson;

        try 
        {
            replacementsJson = JSON.parse(document.getElementById('replacementsJson').value || "{}");
        } catch (error) 
        {
            console.error('Invalid JSON:', error);
            document.getElementById('output').value = 'Invalid JSON. Please ensure that the JSON is valid.';
            return;
        }

        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({textToPreprocess, replacementsJson}),
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('preprocessedText').value = data.preprocessedText;
            document.getElementById('preprocessingLog').value = data.preprocessingLog;
            document.getElementById('errorLog').value = data.errorLog;
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    document.getElementById('submitButton').addEventListener('click', makeApiRequest);
</script>
{% endblock %}